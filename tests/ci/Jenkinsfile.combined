pipeline {
  agent none 
  stages {
    stage('Determine HPC Platform') {
       agent {
        label 'built-in'   
       }
      steps {
        script {
                matchedNode = []
               for (label in pullRequest.labels) {
                   listOfLabelNodeNames = jenkins.model.Jenkins.instance.nodes.collect {
                   node -> node.getLabelString().contains(label) ? node.name : null
                   //println("The value of label is "+label+" the value of node is "+node.name)
                   
                      if ((label.matches(node.getLabelString()+"-(.*)"))) {
                          matchedNode += node.getLabelString()
                      }
                  
                 }

              }
                         println(matchedNode)
                         modifiedLabels = matchedNode.collect{"'" + it + "'"} 
            }
         }
     }    

     stage('Run Tests'){
      
        parallel {
       
           stage('Run Tests on my node') {
             for (mylabel in modifiedLabels) {
                agent {
                  label mylabel 
                } 
             }
             steps {
               sh('echo I ran the tests on ${NODE_NAME}')
             }
           }

        }
     }

  }
}
