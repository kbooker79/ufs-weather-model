matchedNode = []
generateBaselineNode = []
for (label in pullRequest.labels) {
   listOfLabelNodeNames = jenkins.model.Jenkins.instance.nodes.collect {
   node -> node.getLabelString().contains(label) ? node.name : null

   if ((label.matches(node.getLabelString()+"-(.*)"))) {
     matchedNode += node.getLabelString()
   }

   if ((label.matches("(.*)-BL"))) {
     generateBaselineNode += node.getLabelString() 
   }

 }
}

modifiedLabels = matchedNode.collect{"'" + it + "'"} 
baselineLabels = generateBaselineNode.collect{"'" + it + "'"} 

def generateStage(nodeLabel) {
    return {
        stage("Runs on ${nodeLabel}") {
            node(nodeLabel) {
                 checkout([$class: 'GitSCM',
                                  branches: [[name:  'refs/heads/${branch_name}']],
                                  doGenerateSubmoduleConfigurations: false,
                                  extensions: [[$class: 'SubmoduleOption',
                                                disableSubmodules: false,
                                                parentCredentials: false,
                                                recursiveSubmodules: true,
                                                reference: '',
                                                trackingSubmodules: false],
                                                [$class: 'CleanBeforeCheckout'],
                                                [$class: 'CleanCheckout']],
                                  submoduleCfg: [],
                                  userRemoteConfigs: [[url: "$GIT_URL"]]])
               script {
                    echo "Running on ${nodeLabel}"
                    if (baselineLabels.contains(nodeLabel)) {
                      println(nodeLabel+" will need baselines generated.")
                    }
                    else {
                      println(nodeLabel+" will NOT need baselines generated.")
                    }
                }
              }
           }
       }
}
def parallelStagesMap = modifiedLabels.collectEntries {
    ["${it}" : generateStage(it)]
}

pipeline {
    agent none
    stages {
        stage('Run Tests in Parallel') {
            steps {
                script {
                    parallel parallelStagesMap
                }
            }
        }       
    }
}
