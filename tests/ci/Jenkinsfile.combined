pipeline {
  agent none 
  stages {
    stage('Determine HPC Platform') {
       agent {
        label 'built-in'   
       }
      steps {
        script {
                matchedNode = []
               for (label in pullRequest.labels) {
                   listOfLabelNodeNames = jenkins.model.Jenkins.instance.nodes.collect {
                   node -> node.getLabelString().contains(label) ? node.name : null
                   //println("The value of label is "+label+" the value of node is "+node.name)
                   
                      if ((label.matches(node.getLabelString()+"-(.*)"))) {
                          matchedNode += node.getLabelString()
                      }
                  
                 }

              }
                         println(matchedNode)
                         modifiedLabels = matchedNode.collect{"'" + it + "'"} 
                         myLabels = modifiedLabels.join(" && ")
                         println(myLabels)
            }
       }
 }    
     stage('Run Regression Tests') {
        agent {
          label myLabels 
        }
        environment {
        ACCNR = 'epic'
        GITHUB_TOKEN = credentials('GithubJenkinsNew')
      }
      steps {
           sh("echo I would have ran on $NODE_NAME")

             }
     } 
   }
}
